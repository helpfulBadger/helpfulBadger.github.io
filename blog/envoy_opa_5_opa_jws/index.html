<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>JWS Token Validation with OPA - Helpful Badger&#39;s Blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="generator" content="Hugo 0.74.3" /><meta itemprop="name" content="JWS Token Validation with OPA">
<meta itemprop="description" content="Learn how to validate JWS tokens with Open Policy Agent">
<meta itemprop="datePublished" content="2020-09-07T12:10:17-04:00" />
<meta itemprop="dateModified" content="2020-09-07T12:10:17-04:00" />
<meta itemprop="wordCount" content="1808">
<meta itemprop="image" content="https://helpfulbadger.github.io/img/2020/08/jws-signatures-XQaqV5qYcXg-unsplash.jpg">



<meta itemprop="keywords" content="OPA,Open Policy Agent,JWS,Signatures," />
<meta property="og:title" content="JWS Token Validation with OPA" />
<meta property="og:description" content="Learn how to validate JWS tokens with Open Policy Agent" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helpfulbadger.github.io/blog/envoy_opa_5_opa_jws/" />
<meta property="og:image" content="https://helpfulbadger.github.io/img/2020/08/jws-signatures-XQaqV5qYcXg-unsplash.jpg" />
<meta property="article:published_time" content="2020-09-07T12:10:17-04:00" />
<meta property="article:modified_time" content="2020-09-07T12:10:17-04:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://helpfulbadger.github.io/img/2020/08/jws-signatures-XQaqV5qYcXg-unsplash.jpg"/>

<meta name="twitter:title" content="JWS Token Validation with OPA"/>
<meta name="twitter:description" content="Learn how to validate JWS tokens with Open Policy Agent"/>
<link rel="stylesheet" href="/css/bundle.min.182747932867f43d8c875b59a0300848b838002d4008d4a5b8ddcc41a37c4cf7.css" integrity="sha256-GCdHkyhn9D2Mh1tZoDAISLg4AC1ACNSluN3MQaN8TPc="><link rel="stylesheet" href="/css/add-on.css">
</head>

  <body>
    

<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/" class="nav">
        
          
            Blog
          
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu menu">
      
        
          
          
            <a href="/" class="nav link"><i class='fa fa-home'></i> Home</a>
          
        
      
        
          
          
            <a href="/about/" class="nav link"><i class='far fa-id-card'></i> About</a>
          
        
      
        
          
          
            <a href="/blog/" class="nav link"><i class='far fa-newspaper'></i> Blog</a>
          
        
      
        
          
          
            <a href="/categories/" class="nav link"><i class='fas fa-sitemap'></i> Categories</a>
          
        
      
      <a href="#share-menu" class="nav share-toggle"><i class="fas fa-share-alt">&nbsp;</i>Share</a>
      <a href="#search-input" class="nav search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a>
    </menu>
    <a href="#search-input" class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
    <a href="#share-menu" class="nav share-toggle"><i class="fas fa-share-alt fa-2x">&nbsp;</i></a>
    
    <a href="#site-nav" class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="search" class="menu"><input id="search-input" class="search-input menu"></input><div id="search-results" class="search-results menu"></div></menu>
  
  
    <menu id="share-menu" class="flyout-menu menu">
      <h1>Share Post</h1>
      




  
    
    <a href="//twitter.com/share?text=JWS%20Token%20Validation%20with%20OPA&amp;url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f" target="_blank" rel="noopener" class="nav share-btn twitter">
        <i class="fab fa-twitter"></i><p>&nbsp;Twitter</p>
      </a>
  

  
      <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f" target="_blank" rel="noopener" class="nav share-btn facebook">
        <i class="fab fa-facebook"></i><p>&nbsp;Facebook</p>
        </a>
  

  
    <a href="//www.reddit.com/submit?url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f&amp;title=JWS%20Token%20Validation%20with%20OPA" target="_blank" rel="noopener" class="nav share-btn reddit">
          <i class="fab fa-reddit-alien"></i><p>&nbsp;Reddit</p>
        </a>
  

  
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f&amp;title=JWS%20Token%20Validation%20with%20OPA" target="_blank" rel="noopener" class="nav share-btn linkedin">
            <i class="fab fa-linkedin"></i><p>&nbsp;LinkedIn</p>
          </a>
  

  
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f&amp;description=JWS%20Token%20Validation%20with%20OPA" target="_blank" rel="noopener" class="nav share-btn pinterest">
          <i class="fab fa-pinterest-p"></i><p>&nbsp;Pinterest</p>
        </a>
  

  
        <a href="mailto:?subject=Check%20out%20this%20post%20by Helpful%20Badger&amp;body=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f" target="_blank" class="nav share-btn email" data-proofer-ignore>
          <i class="fas fa-envelope"></i><p>&nbsp;Email</p>
        </a>
  


    </menu>
  
</header>

    <div id="wrapper">
      <section id="site-intro" class="hidden-single-column">
  <a href="/"><img src="https://helpfulbadger.github.io/img/main/unsplash_badger_small_2.png" class="circle" width="" alt="Helpful Badger in the wild" /></a>
  <header>
    <h1>Helpful Badger</h1>
  </header>
  <main>
    <p>Imagining the possibilities</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/helpfulBadger" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//linkedin.com/in/example" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>





























      </ul>
    </footer>
  
</section>

      <main id="site-main">
        
  <article class="post">
    <header>
  <div class="title">
    
      <h2><a href="/blog/envoy_opa_5_opa_jws/">JWS Token Validation with OPA</a></h2>
    
    
      <p>Learn how to validate JWS tokens with Open Policy Agent</p>
    
  </div>
  <div class="meta">
    <time class="published" datetime="2020-09-07 12:10:17 -0400 EDT">
      September 7, 2020
    </time>
    <span class="author">Helpful Badger</span>
    
      <p>9 minute read</p>
    
  </div>
</header>

    <section id="socnet-share">
      




  
    
    <a href="//twitter.com/share?text=JWS%20Token%20Validation%20with%20OPA&amp;url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f" target="_blank" rel="noopener" class="nav share-btn twitter">
        <i class="fab fa-twitter"></i><p>&nbsp;Twitter</p>
      </a>
  

  
      <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f" target="_blank" rel="noopener" class="nav share-btn facebook">
        <i class="fab fa-facebook"></i><p>&nbsp;Facebook</p>
        </a>
  

  
    <a href="//www.reddit.com/submit?url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f&amp;title=JWS%20Token%20Validation%20with%20OPA" target="_blank" rel="noopener" class="nav share-btn reddit">
          <i class="fab fa-reddit-alien"></i><p>&nbsp;Reddit</p>
        </a>
  

  
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f&amp;title=JWS%20Token%20Validation%20with%20OPA" target="_blank" rel="noopener" class="nav share-btn linkedin">
            <i class="fab fa-linkedin"></i><p>&nbsp;LinkedIn</p>
          </a>
  

  
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f&amp;description=JWS%20Token%20Validation%20with%20OPA" target="_blank" rel="noopener" class="nav share-btn pinterest">
          <i class="fab fa-pinterest-p"></i><p>&nbsp;Pinterest</p>
        </a>
  

  
        <a href="mailto:?subject=Check%20out%20this%20post%20by Helpful%20Badger&amp;body=https%3a%2f%2fhelpfulbadger.github.io%2fblog%2fenvoy_opa_5_opa_jws%2f" target="_blank" class="nav share-btn email" data-proofer-ignore>
          <i class="fas fa-envelope"></i><p>&nbsp;Email</p>
        </a>
  


    </section>
    
  <a href="/blog/envoy_opa_5_opa_jws/" class="image featured">
    
      <img src="https://helpfulbadger.github.io/img/2020/08/jws-signatures-XQaqV5qYcXg-unsplash.jpg" alt="">
    
  </a>


    <div class="content">
      <p><span>Photo by <a href="https://unsplash.com/@skillscouter?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">SkillScouter</a> on <a href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span></p>
<h1 id="getting-started-with-envoy--open-policy-agent-----05----">Getting Started with Envoy &amp; Open Policy Agent &mdash; 05 &mdash;</h1>
<h2 id="jws-token-validation-with-opa">JWS Token Validation with OPA</h2>
<p>This is the 5th Envoy &amp; Open Policy Agent Getting Started Guide. Each guide is intended to explore a single feature and walk through a simple implementation. Each guide builds on the concepts explored in the previous guide with the end goal of building a very powerful authorization service by the end of the series.</p>
<p>The source code for this getting started example is located on Github. <span style="color:blue"> &mdash;&mdash;&gt;  <a href="https://github.com/helpfulBadger/envoy_getting_started/tree/master/05_opa_validate_jws">Envoy &amp; OPA GS # 5</a> </span></p>
<p>Here is a list of the Getting Started Guides that are currently available.</p>
<h2 id="getting-started-guides">Getting Started Guides</h2>
<ol>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_1_front_proxy/" title="Learn how to set up Envoy as a front proxy with docker">Using Envoy as a Front Proxy</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_2_adding_observability/" title="Learn how to add ElasticSearch and Kibana to your Envoy front proxy environment">Adding Observability Tools</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_3_adding_open_policy_agent/" title="Learn how to use Open Policy Agent with Envoy for more powerful authorization rules">Plugging Open Policy Agent into Envoy</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_4_opa_cli/" title="Learn how to use Open Policy Agent Command Line Interface">Using the Open Policy Agent CLI</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_5_opa_jws/" title="Learn how to validate JWS tokens with Open Policy Agent">JWS Token Validation with OPA</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_6_envoy_jws/" title="Learn how to validate JWS tokens natively with Envoy">JWS Token Validation with Envoy</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_7_app_contracts/" title="Learn how to Implement Application Specific Authorization Rules">Putting It All Together with Composite Authorization</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_8_logs_taps_and_traces/" title="Learn how to configure Envoy's access logs, taps for capturing full requests &amp; responses and traces">Configuring Envoy Logs Taps and Traces</a></span></li>
<li><span style="color:blue"><a href="https://helpfulbadger.github.io/blog/envoy_opa_9_sign_verify/" title="Learn how to use Envoy &amp; OPA to sign and validate HTTP Requests">Sign / Verify HTTP Requests</a></span></li>
</ol>
<h2 id="introduction">Introduction</h2>
<p>This getting started guide will validate 3 different identity tokens that are expressed as Signed JSON web tokens (JWS) for short. This guide assumes knowledge of several IETF RFCs:</p>
<ul>
<li>The format for a JWS and standard claims included in it is specified by the IETF in <span style="color:blue"><a href="https://tools.ietf.org/html/rfc7515">RFC 7515</a></span></li>
<li>The signing algorithms for JSON Web tokens is specified by the IETF in <span style="color:blue"><a href="https://tools.ietf.org/html/rfc7518">RFC 7518</a></span></li>
<li>Encryption keys used for signing and validation are specified by the IETF in <span style="color:blue"><a href="https://tools.ietf.org/html/rfc7517">RFC 7517</a></span></li>
</ul>
<p>There is another tool that was used to create this getting started guide, jose-util:</p>
<ul>
<li>JSON Web Token Signing and Encryption is commonly abbreviated as JOSE</li>
<li>A command line utility called jose-util is available as part of a Golang JOSE library from Square</li>
<li>To install it execute:
<ul>
<li>
<pre><code>go get -u github.com/square/go-jose/jose-util</code></pre>
</li>
<li>
<pre><code>go install github.com/square/go-jose/jose-util</code></pre>
</li>
<li>and make sure your go install directory is in your path</li>
</ul>
</li>
</ul>
<p>Use of this tool is optional since the tool has alredy been used and the results are already stored in the project.</p>
<h2 id="simulated-scenario">Simulated Scenario</h2>
<p>The scenario being simulated is a customer calling into a company to inquire about an order that they have placed. Various JWS tokens are used as a tamper resistent mechanism to communicate information about these participants through the API request chain.</p>
<h2 id="the-json-web-tokens">The JSON Web Tokens</h2>
<p>The keys sub directory contains encryption keys that have been pre-created for you. If you would like to create new keys and have jose-util installed then run the script <code>./generate_keys.sh</code></p>
<p>The <code>identities</code> sub directory contains simulated identity tokens as JSON files. The script <pre><code>./create_jws_tokens.sh</code></pre> can be used to sign and verify these tokens.</p>
<h3 id="proof-of-authentication-for-an-external-customer-user">Proof of Authentication for an External Customer User</h3>
<p>A customer has called in to a company to enquire about an order that they have placed. The customer was authenticated by going through the Voice Response Unit (VRU) and evidence of that authentication is captured as a JWS token and is placed in the <code>subject-token</code> header. The customer identity provider performed the authentication. This token saves repeated database lookups and is used to authorize what the customer can do and has access to.</p>
<ul>
<li>The <code>iss</code> field contains the customer identity provider as the issuer.</li>
<li>The <code>profileRefID</code> is a customer claim that can be used to get the customer&rsquo;s preferences.</li>
<li>The <code>customerRefID</code> is a custom claim that can be used to get details about the customer.</li>
<li>The <code>consentID</code> is a custom claim that can be used to get details about what the customer has consented to and opted out from.</li>
<li>The remaining claims are standard claims that contain information about the token issuance, use and authentication methods performed.</li>
</ul>
<p>The full token is below:</p>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#00f">&#34;iss&#34;: </span><span style="color:#009c00">&#34;customerIdentity.example.com&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#00f">&#34;sub&#34;: </span><span style="color:#009c00">&#34;customerIdentity:DBm4FBclSD261G2&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#00f">&#34;profileRefID&#34;: </span><span style="color:#009c00">&#34;34983598sfkh9w8798798d&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#00f">&#34;customerRefID&#34;: </span><span style="color:#009c00">&#34;DBm4FBclSD261G2&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#00f">&#34;consentID&#34;: </span><span style="color:#009c00">&#34;4378afd4f&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#00f">&#34;aud&#34;: </span>[ <span style="color:#009c00">&#34;apigateway.example.com&#34;</span>, <span style="color:#009c00">&#34;protected-stuff.example.com&#34;</span>],
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#00f">&#34;azp&#34;: </span><span style="color:#009c00">&#34;app_123456&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#00f">&#34;exp&#34;: </span>2735689600,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#00f">&#34;iat&#34;: </span>1597676718,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#00f">&#34;auth_time&#34;: </span>1597676718,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#00f">&#34;jti&#34;: </span><span style="color:#009c00">&#34;o8T2hxraeFzIQ6p&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#00f">&#34;nonce&#34;: </span><span style="color:#009c00">&#34;n-0S6_WzA2Mj&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>    <span style="color:#00f">&#34;acr&#34;: </span><span style="color:#009c00">&#34;urn:mace:incommon:iap:silver&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>    <span style="color:#00f">&#34;amr&#34;: </span>[
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>      <span style="color:#009c00">&#34;face&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>      <span style="color:#009c00">&#34;fpt&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>      <span style="color:#009c00">&#34;geo&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>      <span style="color:#009c00">&#34;mfa&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>    ],
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>    <span style="color:#00f">&#34;vot&#34;: </span><span style="color:#009c00">&#34;P1.Cc.Ac&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>    <span style="color:#00f">&#34;vtm&#34;: </span><span style="color:#009c00">&#34;https://example.org/vot-trust-framework&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>}
</code></pre></div></strong>
<h3 id="proof-of-authentication-for-a-workforce-user">Proof of Authentication for a Workforce User</h3>
<p>The call center agent was authenticated by the application she / he is using. Evidence of that authentication is captured as a JWS token is placed in the <code>actor-token</code> header. The workforce identity provider performed the authentication. This token saves repeated database lookups and is used to authorize what an agent can do on their own behalf as well as what an agent can do on the customer&rsquo;s behalf.</p>
<ul>
<li>The <code>iss</code> field contains the workforce identity provider as the issuer.</li>
<li>The remaining claims are standard claims that contain information about the token issuance, and use.</li>
</ul>
<p>The full token is below:</p>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#00f">&#34;iss&#34;: </span><span style="color:#009c00">&#34;workforceIdentity.example.com&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#00f">&#34;sub&#34;: </span><span style="color:#009c00">&#34;workforceIdentity:406319&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#00f">&#34;aud&#34;: </span>[ <span style="color:#009c00">&#34;apigateway.example.com&#34;</span>, <span style="color:#009c00">&#34;protected-stuff.example.com&#34;</span>],
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#00f">&#34;azp&#34;: </span><span style="color:#009c00">&#34;app_123456&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#00f">&#34;exp&#34;: </span>2735689600,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#00f">&#34;iat&#34;: </span>1597676718,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#00f">&#34;auth_time&#34;: </span>1597676718,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#00f">&#34;jti&#34;: </span><span style="color:#009c00">&#34;mPPdwJ7Jrr2MQzS&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>}
</code></pre></div></strong>
<h3 id="proof-of-authentication-for-an-application">Proof of Authentication for an Application</h3>
<p>The application that the call center agent is using was authenticated by the API gateway. Proof of authentication and application details are placed in the <code>app-token</code> header. This stateless token saves repeated database lookups and is used for application level authorizations.</p>
<ul>
<li>The <code>iss</code> field contains the API gateway as the issuer.</li>
<li>The client_id The remaining claims are standard claims that contain information about the token issuance, and use.</li>
</ul>
<p>The full token is below:</p>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>    <span style="color:#00f">&#34;iss&#34;: </span><span style="color:#009c00">&#34;apigateway.example.com&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    <span style="color:#00f">&#34;sub&#34;: </span><span style="color:#009c00">&#34;apigateway:app_123456&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>    <span style="color:#00f">&#34;aud&#34;: </span>[ <span style="color:#009c00">&#34;apigateway.example.com&#34;</span>, <span style="color:#009c00">&#34;protected-stuff.example.com&#34;</span>],
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>    <span style="color:#00f">&#34;azp&#34;: </span><span style="color:#009c00">&#34;app_123456&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>    <span style="color:#00f">&#34;client_id&#34;: </span><span style="color:#009c00">&#34;app_123456&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>    <span style="color:#00f">&#34;exp&#34;: </span>2735689600,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>    <span style="color:#00f">&#34;iat&#34;: </span>1597676718,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>    <span style="color:#00f">&#34;auth_time&#34;: </span>1597676718,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>    <span style="color:#00f">&#34;jti&#34;: </span><span style="color:#009c00">&#34;XcOpQe2vqTq1kny&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>    <span style="color:#00f">&#34;grant&#34;: </span><span style="color:#009c00">&#34;client_credentials&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>    <span style="color:#00f">&#34;owningLegalEntity&#34;: </span><span style="color:#009c00">&#34;Example Co.&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>    <span style="color:#00f">&#34;scopes&#34;: </span>[
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>      <span style="color:#009c00">&#34;rewards:read&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>      <span style="color:#009c00">&#34;rewards:redeem&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>    ],
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>    <span style="color:#00f">&#34;kid&#34;: </span><span style="color:#009c00">&#34;APIGW-ES256&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>}
</code></pre></div></strong>
<h2 id="open-policy-agent-examples">Open Policy Agent Examples</h2>
<p>In the policy examples directory, there are 2 different REGO policies:</p>
<ul>
<li>jws_examples_v1.rego - which shows three diffent commands to process a JWS</li>
<li>policy.rego - which shows our final policy</li>
</ul>
<h3 id="jws_examples_v1rego">jws_examples_v1.rego</h3>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>verify_example = { <span style="color:#009c00">&#34;isValid&#34;</span>: isValid} {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    isValid := io.jwt.verify_es256(es256_token, jwks)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>}
</code></pre></div></strong>
<p>The io.jwt.verify_xxx function simply checks to see if the signature on the token is valid. It returns a boolean indicating signature validity. It does not check the token claims. The downside of this function is that you must already know the algorithm used and then call the correct validation function.</p>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>decode_example = {<span style="color:#009c00">&#34;header&#34;</span>: header, <span style="color:#009c00">&#34;payload&#34;</span>: payload, <span style="color:#009c00">&#34;signature&#34;</span>: signature} {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    [header, payload, signature] := io.jwt.decode(es256_token)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>}
</code></pre></div></strong>
<p>The io.jwt.decode() function does not validate the JWS. It base64 decodes the token and returns it&rsquo;s constituent parts (header, payload and signature).</p>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>decode_verify_example = { <span style="color:#009c00">&#34;isValid&#34;</span>: isValid, <span style="color:#009c00">&#34;header&#34;</span>: header, <span style="color:#009c00">&#34;payload&#34;</span>: payload } {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>     [isValid, header, payload] := io.jwt.decode_verify(es256_token, { <span style="color:#009c00">&#34;cert&#34;</span>: jwks, <span style="color:#009c00">&#34;iss&#34;</span>: <span style="color:#009c00">&#34;xxx&#34;</span>, })
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>}
</code></pre></div></strong>
<p>The io.jwt.decode_verify() function detects the correct algorithm from the JWS headers, validates the signature and validates the claims in the token. The second parameter for the decode and verify function is an object that contains the validation parameters. The cert property must be a string. A JSON web token keyset must be serialized to a string if you have it already read into memory as a parsed object. The other properties in the object are the expected token values. If an audience claim is specified in the token, then an audience claim must be specified in the parameter list. The audience claim is also assumed to be an array of strings. Audience claim validation checks for the presence of the supplied audience string anywhere in the audience claim array in the JWS.</p>
<p>The REGO policy in this file decodes the token using all 3 functions above and assigns them to the result.</p>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-javascript" data-lang="javascript"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span>result = {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span>    <span style="color:#009c00">&#34;verify_example&#34;</span>: verify_example,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span>    <span style="color:#009c00">&#34;decode_example&#34;</span>: decode_example,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span>    <span style="color:#009c00">&#34;decode_verify_example&#34;</span>: decode_verify_example
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span>}
</code></pre></div></strong>
<p>The output below shows the result of executing the policy.</p>
<strong>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-yaml" data-lang="yaml"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span>  <span style="color:#00f">&#34;result&#34;: </span>[
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span>    {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span>      <span style="color:#00f">&#34;expressions&#34;: </span>[
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span>        {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span>          <span style="color:#00f">&#34;value&#34;: </span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span>            <span style="color:#00f">&#34;decode_example&#34;: </span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span>              <span style="color:#00f">&#34;header&#34;: { &#34;alg&#34;: &#34;ES256&#34;,  &#34;typ&#34;: </span><span style="color:#009c00">&#34;JWT&#34;</span> },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span>              <span style="color:#00f">&#34;payload&#34;: { &#34;iss&#34;: &#34;xxx&#34;, &#34;nbf&#34;: </span>1444478400 },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span>              <span style="color:#00f">&#34;signature&#34;: </span><span style="color:#009c00">&#34;940adccdf37ea482fca1453eecf53cdeefb37d7a2e8170598fa76b15e285b0f128561cbd580ca266546c858aa34d25dd6b0f32c362fea2fb78cd35196f63d632&#34;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span>            },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span>            <span style="color:#00f">&#34;decode_verify_example&#34;: </span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span>              <span style="color:#00f">&#34;header&#34;: { &#34;alg&#34;: &#34;ES256&#34;,  &#34;typ&#34;: </span><span style="color:#009c00">&#34;JWT&#34;</span> },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span>              <span style="color:#00f">&#34;isValid&#34;: </span><span style="color:#00f">true</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span>              <span style="color:#00f">&#34;payload&#34;: { &#34;iss&#34;: &#34;xxx&#34;, &#34;nbf&#34;: </span>1444478400 }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span>            },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span>            <span style="color:#00f">&#34;verify_example&#34;: </span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span>              <span style="color:#00f">&#34;isValid&#34;: </span><span style="color:#00f">true</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span>            }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span>          },
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span>          <span style="color:#00f">&#34;text&#34;: </span><span style="color:#009c00">&#34;data.jws.examples.v1.result&#34;</span>,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span>          <span style="color:#00f">&#34;location&#34;: </span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span>            <span style="color:#00f">&#34;row&#34;: </span>1,
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span>            <span style="color:#00f">&#34;col&#34;: </span>1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span>          }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span>        }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span>      ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span>  ]
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span>}
</code></pre></div></strong>
<p>The policy_examples directory contains several scripts and rego policies that demonstrates 5 different ways to invoke our policy:</p>
<ol>
<li><code>policy_examples/run_rego_tests_locally.sh</code> - This script runs the test policies with a locally installed Open Policy Agent. <img class="special-img-class" src="/img/2020/08/05_run_rego_tests_locally.png" /><br> As you can see from this example, the output looks much like outpu from test runners in most other languages.</li>
<li><code>policy_examples/run_rego_tests_in_docker.sh</code> - This script runs the test policies using the Open Policy Agent docker container and a locally mapped volume  <img class="special-img-class" src="/img/2020/08/05_run_rego_tests_in_docker.png" /><br> The nice part about using this approach is that it doesn&rsquo;t require anything installed locally other than docker.</li>
<li><code>policy_examples/run_opa_cli.sh</code> - This script uses <code>eval</code> statements to test policies using the Open Policy Agent docker container. It shows the results of using all 3 JWS functions <code>io.jwt.verify_es256()</code>, <code>io.jwt.decode()</code> and <code>io.jwt.decode_verify()</code> REGO commands in <code>jws_examples_v1.rego</code>. Additionally it shows using eval statements with our final <code>policy.rego</code>. You should see an output similar to this for each request. <img class="special-img-class" src="/img/2020/08/05_run_opa_cli_output.png" /><br> As you can see from this example and the REST API example that follows, the output from the eval statement approach and the REST API approach are a bit different. The eval statement technique returns a result object and an array of expression evalution objects. Within each of those objects is a value object that finally contains our results.</li>
<li><code>policy_examples/run_opa_rest_decision_api_tests.sh</code> - uses Curl commands and OPA&rsquo;s REST API running in docker.  <img class="special-img-class" src="/img/2020/08/05_run_opa_rest_decision_api_tests.png" /><br> The REST API has both a decision ID and the results in a results object. The decision ID can be used to with Open Policy Agent&rsquo;s decision logs to find out more information about how the result was arrived at.</li>
<li><code>demonstrate_opa_jws_validation.sh</code> - This script uses the final solution that shows our fully integrated solution with Envoy. This script uses Curl to make requests to our target service. Envoy asks OPA for an authorization decision prior to forwarding to HTTPBIN. <img class="special-img-class" src="/img/2020/08/05_demonstrate_opa_jws_validation.png" /><br> In the final result you can see the details of the curl request going into Envoy and the decision is implied from being able to see the response from the requested API or a 403 Forbidden response is given.</li>
</ol>
<h1 id="conclusion">Conclusion</h1>
<p>The difficult part of getting this solution to work is tinkering required to get the Envoy configuration correct and understanding the idiosyncrasies of each of the Open Policy agent JWS functions. The purpose of this article is to shortcut that process for you by giving you a known good starting point with a working configuration and rego policy. Once you have a functioning example, it is easy to adapt the example to whatever your local use cases might be.</p>
<p>In the next getting started guide, we are going to show how you can also validate JWS tokens in Envoy without using OPA at. This gives you a choice to make about where you would like that authorization decision to be made.</p>

    </div>
    <footer>
      <ul class="stats">
  <li class="categories">
    <ul>
    
      
        
          <li><a class="article-terms-link" href="/categories/cloud/">cloud</a></li>
        
          <li><a class="article-terms-link" href="/categories/security/">Security</a></li>
        
          <li><a class="article-terms-link" href="/categories/authentication/">Authentication</a></li>
        
      
    
    </ul>
  </li>
  <li class="tags">
    <ul>
    
      
        
          <li><a class="article-terms-link" href="/tags/opa/">OPA</a></li>
        
          <li><a class="article-terms-link" href="/tags/open-policy-agent/">Open Policy Agent</a></li>
        
          <li><a class="article-terms-link" href="/tags/jws/">JWS</a></li>
        
          <li><a class="article-terms-link" href="/tags/signatures/">Signatures</a></li>
        
      
    
    </ul>
  </li>
</ul>

    </footer>
  </article>
  

  <div class="pagination">
  
    <a href="/blog/envoy_opa_4_opa_cli/" class="button"><div class="previous"><div>Using the Open Policy Agent CLI</div></div></a>
  
  
    <a href="/blog/envoy_opa_6_envoy_jws/" class="button"><div class="next"><div>JWS Signature Validation with Envoy</div></div></a>
  
</div>


      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>Recent posts</h1>
      </header>
      
      <article class="mini-post">
        <section>
          
  <a href="/blog/envoy_opa_9_sign_verify/" class="image featured">
    
      <img src="https://helpfulbadger.github.io/img/2020/10/lock-key-hRXIKdxoaPo-unsplash.jpg" alt="">
    
  </a>


        </section>
        <header>
          <h2><a href="/blog/envoy_opa_9_sign_verify/">Signing HTTP Requests</a></h2>
          <time class="published" datetime="">October 7, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          
  <a href="/blog/envoy_opa_8_logs_taps_and_traces/" class="image featured">
    
      <img src="https://helpfulbadger.github.io/img/2020/08/tap-dPr7uyrFMXo-unsplash.jpg" alt="">
    
  </a>


        </section>
        <header>
          <h2><a href="/blog/envoy_opa_8_logs_taps_and_traces/">Configuring Envoy Logs, Taps and Traces</a></h2>
          <time class="published" datetime="">September 10, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          
  <a href="/blog/envoy_opa_7_app_contracts/" class="image featured">
    
      <img src="https://helpfulbadger.github.io/img/2020/08/app-authorization-A6qNzfJXRGQ-unsplash.jpg" alt="">
    
  </a>


        </section>
        <header>
          <h2><a href="/blog/envoy_opa_7_app_contracts/">Putting It All Together with Composite Authorization</a></h2>
          <time class="published" datetime="">September 7, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          
  <a href="/blog/envoy_opa_6_envoy_jws/" class="image featured">
    
      <img src="https://helpfulbadger.github.io/img/2020/08/jws-signatures-GJao3ZTX9gU-unsplash.jpg" alt="">
    
  </a>


        </section>
        <header>
          <h2><a href="/blog/envoy_opa_6_envoy_jws/">JWS Signature Validation with Envoy</a></h2>
          <time class="published" datetime="">September 7, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          
  <a href="/blog/envoy_opa_5_opa_jws/" class="image featured">
    
      <img src="https://helpfulbadger.github.io/img/2020/08/jws-signatures-XQaqV5qYcXg-unsplash.jpg" alt="">
    
  </a>


        </section>
        <header>
          <h2><a href="/blog/envoy_opa_5_opa_jws/">JWS Token Validation with OPA</a></h2>
          <time class="published" datetime="">September 7, 2020</time>
        </header>
      </article>
      
      
        <footer>
          <a href="/blog/" class="button">See more</a>
        </footer>
      
    </section>
  

  
    
      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
            
          
          
          <li>
            
              <a href="/categories/cloud/">cloud<span class="count">9</span></a>
            
          
          <li>
            
              <a href="/categories/security/">security<span class="count">5</span></a>
            
          
          <li>
            
              <a href="/categories/service-mesh/">service-mesh<span class="count">5</span></a>
            
          
          <li>
            
              <a href="/categories/observability/">observability<span class="count">4</span></a>
            
          
          <li>
            
              <a href="/categories/authentication/">authentication<span class="count">3</span></a>
            
          
          </li>
        </ul>
      </section>
    
  

  
    <section id="mini-bio">
      <header>
        <h1>About</h1>
      </header>
      <p>Sharing perspectives.</p>
      <footer>
        <a href="/about" class="button">Learn More</a>
      </footer>
    </section>
  
</section>

      <footer id="site-footer">
  
      <ul class="socnet-icons">
        

        <li><a href="//github.com/helpfulBadger" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//linkedin.com/in/example" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>





























      </ul>
  
  <p class="copyright">
    
      &copy; 2020
      
        Helpful Badger&#39;s Blog
      
    . <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.74.3' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      <script src="/js/bundle.min.a130f793c5bbd8f5902d41386b68a11988891ebc5f9a990f2176557ef014e758.js" integrity="sha256-oTD3k8W72PWQLUE4a2ihGYiJHrxfmpkPIXZVfvAU51g="></script>
    <script src="/js/add-on.js"></script>
    </div>
  </body>
</html>
